---
title: Github Action to upload SimpleCov Coverage Results
date: "2019-10-16"
template: "post"
draft: false
slug: "github-action-rspec-simplecov"
category: "Programming"
tags:
  - "github"
  - "actions"
  - "ruby"
  - "gem"
  - "rspec"
  - "simplecov"
description: "I've been playing around with Actions ever since and one of my new projects, a Ruby Gem, didn't have any form of CI as of this morning. I set out to create an Action that would run the tests for the gem and produce coverage results via SimpleCov."
socialImage:
---

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Check now ðŸ˜Ž</p>&mdash; Nat Friedman (@natfriedman) <a href="https://twitter.com/natfriedman/status/1162823584684732416?ref_src=twsrc%5Etfw">August 17, 2019</a></blockquote>

What a wonderful day that was! I've been playing around with Actions ever since and one of my new projects, a Ruby Gem, didn't have any form of CI as of this morning. I set out to create an Action that would run the tests for the gem and produce coverage results via [SimpleCov](https://github.com/colszowka/simplecov). While it's nothing too extravagant, there was a small nuance that I had to resolve and I decided I wanted to share that info.

Let's start off with some changes to the `SimpleCov` configuration.

```ruby
if ENV.fetch('COVERAGE', false)
  SimpleCov.start do
    minimum_coverage 90
    maximum_coverage_drop 2
  end
end
```

This ensures that the coverage is above 90% and any changes in the future must not drop the coverage by more than 2%. The Gem, in its infancy, does not pass this requirement. Due to that failure, I had to figure out why the Action was not uploading the coverage results. Remember to put the `SimpleCov` code at the very top of `spec_helper.rb`, before you do `require 'your_gem'` to ensure it knows what files to track.

Now let's look at the Action, which is based off the default [Ruby Action](https://github.com/actions/starter-workflows/blob/master/ci/ruby.yml) supplied by Github.

```yaml
name: RSpec with SimpleCov for a Gem

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      - name: Set up Ruby 2.6
        uses: actions/setup-ruby@v1
        with:
          ruby-version: 2.6.x
      - name: Build and test with Rake
        run: |
          gem install bundler -v '1.17.3'
          bundle install --jobs 4 --retry 3
          COVERAGE=true bundle exec rspec
      - name: Upload coverage results
        uses: actions/upload-artifact@master
        if: always()
        with:
          name: coverage-report
          path: coverage
```

The only additions are the last step.

```yaml
- name: Upload coverage results
  uses: actions/upload-artifact@master
  if: always()
  with:
    name: coverage-report
    path: coverage
```

It uses the [upload-artifact Action](https://github.com/actions/upload-artifact) created by Github to upload the `coverage/` folder generated by `SimpleCov`. At first, I could not figure out why the artifact was never being uploaded, but I realized that the step was never being run. We can see this in the Actions UI.

![action no artifact](media/action_no_artifact.png)

The key to making this work is the `if: always()` clause. Looking at the documentation for [Contexts and Expression Syntax](https://help.github.com/en/articles/contexts-and-expression-syntax-for-github-actions#always), `always()` is described as `Forces a conditional to evaluate as true, even when canceled.` Since `SimpleCov` is failing the `Build and test with Rake` step, we have to force the `Upload coverage results` step to always run. After adding in the if clause, we can see a successful upload in the Actions UI.

![action with artifact](media/action_with_artifact.png)

Next we scroll to the top of the page and download the artifact, which is a zip file of the `coverage/` folder.

![download artifact](media/download_artifact.png)

Inside the folder we can open the generated `index.html` to see which files we didn't have coverage for.

![coverage report](media/coverage_report.png)

Now we can successfully check the coverage report on our gem and see where the tests are lacking. Hopefully your gem has better coverage than mine!

You can find the file in my [actions](https://github.com/jer-k/actions) repository, or directly [here](https://github.com/jer-k/actions/blob/master/rspec-with-simplecov-for-gem.yml)
